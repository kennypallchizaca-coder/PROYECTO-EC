formatBitrate } from '../utils/formatTime';

export const HomeScreen: React.FC = () => {
  const navigation = useNavigation<BottomTabNavigationProp<TabParamList>>();
  const { theme, currentStation, selectStation, isPlaying } = usePlayer();
  const [station, setStation] = useState<Station | null>(null);

  useEffect(() => {
    const load = async () => {
      const data = await fetchStations();
      setStation(data[0] ?? null);
    };
    load();
  }, []);

  const activeStation = useMemo(() => currentStation ?? station, [currentStation, station]);
  const isCurrent = activeStation && currentStation?.id === activeStation.id;

  const handleListen = useCallback(async () => {
    if (!activeStation) return;
    if (isCurrent && isPlaying) {
      navigation.navigate('Player');
      return;
    }
    await selectStation(activeStation);
    navigation.navigate('Player');
  }, [activeStation, isCurrent, isPlaying, navigation, selectStation]);

  return (
    <ScrollView style={{ backgroundColor: theme.colors.background }} contentContainerStyle={styles.container}>
      <Logo />

      {activeStation && (
        <View style={styles.heroWrapper}>
          <ImageBackground
            source={typeof activeStation.image === 'string' ? { uri: activeStation.image } : activeStation.image}
            style={styles.heroImage}
            imageStyle={styles.heroImageStyle}
            accessibilityIgnoresInvertColors
          >
            <LinearGradient
              colors={['rgba(15,23,42,0.1)', 'rgba(15,23,42,0.85)']}
              start={{ x: 0, y: 0 }}
              end={{ x: 0, y: 1 }}
              style={styles.heroOverlay}
            >
              <Text style={[styles.pill, { color: theme.colors.onPrimary, backgroundColor: theme.colors.primary }]}>LIVE</Text>
              <Text style={[styles.title, { color: theme.colors.onPrimary }]}>{activeStation.name}</Text>
              <Text style={[styles.meta, { color: theme.colors.onPrimary }]}>
                {`${activeStation.genre} · ${activeStation.country} · ${formatBitrate(activeStation.bitrateKbps)}`}
              </Text>
              <Text style={[styles.description, { color: theme.colors.onPrimary }]} numberOfLines={2}>
                {activeStation.description}
              </Text>
              <View style={styles.ctaRow}>
                <IconButton size={68} icon={isPlaying ? 'pause' : 'play'} label="Escuchar ahora" onPress={handleListen} />
              </View>
            </LinearGradient>
          </ImageBackground>
        </View>
      )}
    </ScrollView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 24,
    gap: 16,
  },
  heroWrapper: {
    borderRadius: 32,
    overflow: 'hidden',
  },
  heroImage: {
    height: 280,
    justifyContent: 'flex-end',
  },
  heroImageStyle: {
    borderRadius: 32,
  },
  heroOverlay: {
    padding: 24,
    gap: 10,
  },
  pill: {
    alignSelf: 'flex-start',
    paddingHorizontal: 10,
    paddingVertical: 6,
    borderRadius: 999,
    fontSize: 12,
    fontWeight: '700',
    letterSpacing: 1,
  },
  title: {
    fontSize: 26,
    fontWeight: '800',
  },
  meta: {
    fontSize: 13,
    letterSpacing: 0.8,
    textTransform: 'uppercase',
  },
  description: {
    fontSize: 15,
    lineHeight: 20,
  },
  ctaRow: {
    marginTop: 8,
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
  },
});

export default HomeScreen;




